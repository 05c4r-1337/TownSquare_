@model TownSquare.ViewModels.EventDetailsViewModel

@{
    ViewData["Title"] = "Event Details";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <h2>@Model.Event.Title</h2>
        <hr />

        <div class="card mb-3">
            <div class="card-body">
                <div class="mb-3">
                    <span class="badge bg-primary">@Model.Event.Category</span>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Description:</strong>
                    </div>
                    <div class="col-md-8">
                        @Model.Event.Description
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Date:</strong>
                    </div>
                    <div class="col-md-8">
                        @Model.Event.Date.ToString("MMMM dd, yyyy")
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Time:</strong>
                    </div>
                    <div class="col-md-8">
                        @Model.Event.Time.ToString(@"hh\:mm")
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Location:</strong>
                    </div>
                    <div class="col-md-8">
                        @Model.Event.Location
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Organizer:</strong>
                    </div>
                    <div class="col-md-8">
                        @Model.Event.User?.FullName
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>RSVPs:</strong>
                    </div>
                    <div class="col-md-8">
                        @Model.RSVPCount @(Model.RSVPCount == 1 ? "person" : "people")
                    </div>
                </div>
            </div>
        </div>

        @if (Model.Weather != null)
        {
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Weather Forecast for Borås</h5>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="d-flex align-items-center mb-3">
                                <span style="font-size: 3rem;">@Model.Weather.Icon</span>
                                <div class="ms-3">
                                    <h3 class="mb-0">@Model.Weather.Temperature.ToString("F1")°C</h3>
                                    <p class="mb-0 text-muted">@Model.Weather.Description</p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Wind Speed:</strong> @Model.Weather.WindSpeed.ToString("F1") km/h
                                </div>
                                <div class="col-md-6">
                                    <strong>Precipitation Probability:</strong> @Model.Weather.Humidity%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (Model.IsAuthenticated && Model.RSVPUsers.Count > 0)
        {
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Who's Attending</h5>
                    <ul class="list-unstyled">
                        @foreach (var user in Model.RSVPUsers)
                        {
                            <li><i class="bi bi-person-check"></i> @user.FullName</li>
                        }
                    </ul>
                </div>
            </div>
        }

        <div class="mt-3 d-flex gap-2">
            @if (Model.IsAuthenticated)
            {
                @if (Model.CurrentUserRSVPd)
                {
                    <form asp-action="CancelRSVP" asp-route-id="@Model.Event.Id" method="post" class="d-inline">
                        <button type="submit" class="btn btn-warning">Cancel RSVP</button>
                    </form>
                }
                else
                {
                    <form asp-action="RSVP" asp-route-id="@Model.Event.Id" method="post" class="d-inline">
                        <button type="submit" class="btn btn-success">RSVP</button>
                    </form>
                }

                var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                var isOwner = Model.Event.UserId == currentUserId;
                var isAdmin = User.FindFirst("Role")?.Value == "Admin";

                if (isOwner || isAdmin)
                {
                    <a asp-action="Edit" asp-route-id="@Model.Event.Id" class="btn btn-primary">Edit</a>
                    <a asp-action="Delete" asp-route-id="@Model.Event.Id" class="btn btn-danger">Delete</a>
                }
            }
            else
            {
                <a asp-controller="Account" asp-action="Login" class="btn btn-primary">Login to RSVP</a>
            }
            <a asp-action="Index" class="btn btn-secondary">Back to List</a>
        </div>
    </div>
</div>
